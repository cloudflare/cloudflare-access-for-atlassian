<atlassian-plugin key="${atlassian.plugin.key}" name="${project.name}" plugins-version="2">
    <plugin-info>
        <description>${project.description}</description>
        <version>${project.version}</version>
        <vendor name="${project.organization.name}" url="${project.organization.url}" />
        <param name="plugin-icon">images/cf-icon.png</param>
        <param name="plugin-logo">images/cf-logo.png</param>
    </plugin-info>

	<web-resource name="Cloudflare Access Plugin web resources" key="webResources">
		<resource type="download" name="override.css" location="/css/override.css"/>
		<context>com.cloudflare.access.atlassian</context>
		<context>bitbucket.page.errors</context>
	</web-resource>
	
    <servlet-filter name="Cloudflare Access Auth Filter" key="cloudflareAccessAuthFilter" 
    				class="com.cloudflare.access.atlassian.bitbucket.auth.CloudflareAccessAuthenticationFilter" 
    				location="before-login" weight="200">
        <description>Check authentication headers</description>
        <url-pattern>/*</url-pattern>
        <dispatcher>REQUEST</dispatcher>
        <dispatcher>FORWARD</dispatcher>
    </servlet-filter>

    <servlet-filter name="Cloudflare Access Logout Filter" key="cloudflareAccessLogoutFilter" 
    				class="com.cloudflare.access.atlassian.bitbucket.auth.CloudflareAccessLogoutFilter" 
    				location="before-login" weight="100">
        <description>Intercepts logout calls and logout user from Cloudflare Access</description>
        <url-pattern>/j_atl_security_logout</url-pattern>
        <dispatcher>REQUEST</dispatcher>
        <dispatcher>FORWARD</dispatcher>
    </servlet-filter>
    
    <http-auth-handler key="containerAuthenticationHandler"
                       class="bean:cloudflareAccessAuthenticationHandler"
                       weight="100"/>

    <http-auth-success-handler key="containerAuthenticationSuccessHandler"
                       class="bean:cloudflareAccessAuthenticationHandler"
                       weight="50"/>

    <servlet name="Authentication Error Servlet" i18n-name-key="authentication-error-servlet.name" key="authenticationErrorServlet" class="com.cloudflare.access.atlassian.base.auth.AuthenticationErrorServlet">
        <description key="authentication-error-servlet.description">Custom error page to display authentication errors</description>
        <url-pattern>/cloudflareaccess/auth/error.vm</url-pattern>
	    <init-param>
	    	<param-name>loginPath</param-name>
	    	<param-value>/login</param-value>
	    </init-param>
    </servlet>
            
    <resource type="i18n" name="i18n" location="pluginMessages"/>
    
	<ao name="Cloudflare Access Active Objects" key="cloudflareAccessActiveObjects" >
	  <description>The module configuring the Active Objects service used by this plugin</description>
	  <entity>com.cloudflare.access.atlassian.base.config.ConfigurationVariablesActiveObject</entity>
	</ao>
    
	<servlet name="Cloudflare Access Configuration Servlet" key="cloudflareAccessConfigServlet" class="com.cloudflare.access.atlassian.base.config.ConfigurationServlet">
	  <description>Servlet to process configuration requests</description> 
	  <url-pattern>/cloudflareaccess/config</url-pattern>
	</servlet>
	
	<web-item name="Cloudflare Access Configuration Link" key="cloudflareAccessConfigMenuItem" 
				section="atl.admin/admin-general-section" 
				weight="90" >
	  <description>Link to Cloudflare Access Configuration page.</description> 
	  <label>Cloudflare Access</label> 
	  <link linkId="cloudflareAccessConfigLink">/plugins/servlet/cloudflareaccess/config</link> 
	</web-item>
	
  	<rest name="Update Check Resource" i18n-name-key="update-check.name" key="updateCheckResource" path="/cloudflare" version="1.0">
		<description key="update-check.description">Servlet to check for updates</description>
  	</rest>

	<web-resource name="Cloudflare Access Plugin Global Resources" key="globalWebResources">
		<resource type="download" name="cloudflareAccessUpdateNotification.js" location="/js/updateNotification.js"/>
		<context>atl.general</context>
		<context>atl.admin</context>
	</web-resource>
	
	
</atlassian-plugin>